<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metrostav – Report FB kampaní</title>
  <meta name="description" content="Online report Meta Ads kampaní – filtrování dle divizí." />

  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.09);
      --border:rgba(255,255,255,.12); --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65); --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:18px; --pad:18px; --accent:#7c5cff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(45,212,191,.18), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:24px}
    header{display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .hgroup h1{margin:0;font-size:20px}
    .hgroup p{margin:6px 0 0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .period-pill{margin-left:auto}

    .pill{
      border:1px solid var(--border);background:var(--panel);
      border-radius:999px;padding:8px 10px;font-size:13px;
      display:flex;gap:6px;align-items:center
    }
    select,input{
      background:transparent;border:none;color:var(--text);outline:none;font-size:13px
    }
    .btn{
      border:1px solid var(--border);background:rgba(255,255,255,.05);
      color:var(--text);border-radius:999px;padding:8px 12px;font-size:13px;
      cursor:pointer
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:18px 0}
    .tab{
      border:1px solid var(--border);background:rgba(255,255,255,.04);
      border-radius:999px;padding:9px 12px;font-size:13px;cursor:pointer
    }
    .tab.active{background:rgba(124,92,255,.25);border-color:rgba(124,92,255,.5)}

    .grid{display:grid;gap:12px;grid-template-columns:repeat(6,1fr)}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}

    .card{background:linear-gradient(180deg,var(--panel2),var(--panel));
      border:1px solid var(--border);border-radius:var(--r);padding:14px}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    th{font-size:12px;color:var(--muted);text-align:left;position:sticky;top:0;background:rgba(11,18,32,.9)}
    td{font-size:13px}
    .right{text-align:right}
    .small{font-size:12px}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">

<header>
  <div class="hgroup">
    <h1>Metrostav – report FB kampaní</h1>
    <p>Divize se čte z názvu kampaně <span class="badge">(D6)</span>. Kampaně bez divize se nezobrazují.</p>
  </div>

  <div class="controls">
    <div class="pill period-pill">
      Období:
      <select id="period">
        <option value="7d">7 dní</option>
        <option value="30d" selected>30 dní</option>
        <option value="90d">90 dní</option>
        <option value="180d">180 dní</option>
        <option value="365d">365 dní</option>
      </select>
    </div>

    <div class="pill">Od: <input id="since" type="date"></div>
    <div class="pill">Do: <input id="until" type="date"></div>

    <div class="pill">Hledat: <input id="q" placeholder="název kampaně…"></div>
    <button class="btn" id="refreshBtn">Obnovit</button>
  </div>
</header>

<div id="tabs" class="tabs"></div>

<div class="grid" id="kpis"></div>

<div class="card">
<table>
<thead>
<tr>
  <th>Kampaň</th>
  <th>Od</th>
  <th>Do</th>
  <th>Divize</th>
  <th class="right">Spend</th>
  <th class="right">Impr.</th>
  <th class="right">Clicks</th>
  <th class="right">Reach</th>
  <th class="right">CTR</th>
  <th class="right">CPC</th>
  <th class="right">Results</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
const fmtCZK=n=>new Intl.NumberFormat("cs-CZ",{style:"currency",currency:"CZK",maximumFractionDigits:0}).format(n||0);
const fmtInt=n=>new Intl.NumberFormat("cs-CZ").format(n||0);
const pct=n=>`${(n||0).toFixed(2)} %`;

const state={
  period:new URLSearchParams(location.search).get("period")||"30d",
  division:new URLSearchParams(location.search).get("division")||"D6",
  q:new URLSearchParams(location.search).get("q")||"",
  since:new URLSearchParams(location.search).get("since")||"",
  until:new URLSearchParams(location.search).get("until")||"",
};

period.value=state.period;
q.value=state.q;
since.value=state.since;
until.value=state.until;

function setParam(k,v){
  const u=new URL(location.href);
  v?u.searchParams.set(k,v):u.searchParams.delete(k);
  history.replaceState(null,"",u);
}

async function fetchCampaigns(){
  let url=`/api/campaigns?division=${state.division}`;
  if(state.since&&state.until){
    url+=`&since=${state.since}&until=${state.until}`;
  }else{
    url+=`&period=${state.period}`;
  }
  return fetch(url,{cache:"no-store"}).then(r=>r.json());
}

function renderTabs(rows){
  tabs.innerHTML="";
  [...new Set(rows.map(r=>r.division))]
    .filter(d=>/^D\d+$/.test(d))
    .sort((a,b)=>+a.slice(1)-+b.slice(1))
    .forEach(d=>{
      const b=document.createElement("button");
      b.className="tab"+(d===state.division?" active":"");
      b.textContent=`Divize ${d.slice(1)}`;
      b.onclick=()=>{state.division=d;setParam("division",d);load()};
      tabs.appendChild(b);
    });
}

function renderTable(rows){
  tbody.innerHTML="";
  rows.filter(r=>r.division!=="Nezařazeno")
      .filter(r=>r.campaign_name.toLowerCase().includes(state.q.toLowerCase()))
      .forEach(r=>{
        tbody.insertAdjacentHTML("beforeend",`
          <tr>
            <td>${r.campaign_name}</td>
            <td class="small">${r.date_start||"—"}</td>
            <td class="small">${r.date_stop||"—"}</td>
            <td><span class="badge">${r.division}</span></td>
            <td class="right">${fmtCZK(r.spend)}</td>
            <td class="right">${fmtInt(r.impressions)}</td>
            <td class="right">${fmtInt(r.clicks)}</td>
            <td class="right">${fmtInt(r.reach)}</td>
            <td class="right">${pct(r.ctr)}</td>
            <td class="right">${fmtCZK(r.cpc)}</td>
            <td class="right">${fmtInt(r.results)}</td>
          </tr>`);
      });
}

async function load(){
  const all=await fetch(`/api/campaigns?division=Vše&period=${state.period}`).then(r=>r.json());
  renderTabs(all.campaigns||[]);
  const data=await fetchCampaigns();
  renderTable(data.campaigns||[]);
}

period.onchange=e=>{state.period=e.target.value;setParam("period",state.period);load()};
since.onchange=e=>{state.since=e.target.value;setParam("since",state.since);load()};
until.onchange=e=>{state.until=e.target.value;setParam("until",state.until);load()};
q.oninput=e=>{state.q=e.target.value;setParam("q",state.q);renderTable(window._rows||[])};
refreshBtn.onclick=()=>load();

load();
</script>

</body>
</html>
