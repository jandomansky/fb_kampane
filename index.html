<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metrostav ‚Äì Report FB kampan√≠</title>
  <meta name="description" content="Online report Meta Ads kampan√≠ ‚Äì filtrov√°n√≠ dle diviz√≠." />
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.09);
      --border:rgba(255,255,255,.12); --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65); --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:18px; --r2:14px; --pad:18px; --accent:#7c5cff; --accent2:#2dd4bf;
      --danger:#ff4d6d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(45,212,191,.18), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:24px}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .hgroup h1{margin:0;font-size:20px;letter-spacing:.2px}
    .hgroup p{margin:6px 0 0;color:var(--muted);font-size:13px;max-width:820px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      border-radius:999px; padding:8px 10px; font-size:13px;
      display:flex; gap:8px; align-items:center;
    }
    select, input{
      background:transparent;color:var(--text);border:none;outline:none;font-size:13px;
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .card{
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      border:1px solid var(--border); border-radius:var(--r);
      box-shadow:var(--shadow);
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:18px 0}
    .tab{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(124,92,255,.22);
      border-color:rgba(124,92,255,.45);
      box-shadow:0 10px 26px rgba(124,92,255,.18);
    }
    .grid{
      display:grid; gap:12px;
      grid-template-columns:repeat(6, minmax(0,1fr));
      margin-bottom:14px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:600px){ .grid{grid-template-columns:repeat(2,1fr)} }
    .kpi{padding:14px}
    .kpi .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .kpi .value{font-size:18px;font-weight:700;letter-spacing:.2px}
    .kpi .sub{color:var(--muted);font-size:12px;margin-top:6px}
    .table{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{position:sticky;top:0;background:rgba(11,18,32,.9);backdrop-filter:blur(10px);text-align:left;font-size:12px;color:var(--muted)}
    td{font-size:13px}
    .name{font-weight:650}
    .muted{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;
      padding:5px 9px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text);
    }
    .right{text-align:right}
    .small{font-size:12px}
    .footer{margin-top:14px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .dot{width:9px;height:9px;border-radius:999px;background:rgba(45,212,191,.9);box-shadow:0 0 0 4px rgba(45,212,191,.18)}
    .dot.bad{background:rgba(255,77,109,.95);box-shadow:0 0 0 4px rgba(255,77,109,.18)}
    .spinner{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.85);
      animation:spin .8s linear infinite;
      display:inline-block;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .err{
      margin:12px 0;
      padding:12px 14px;
      border:1px solid rgba(255,77,109,.35);
      background:rgba(255,77,109,.08);
      border-radius:14px;
      color:rgba(255,255,255,.9);
      font-size:13px;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="hgroup">
        <h1>Metrostav ‚Äì report FB kampan√≠</h1>
        <p>
          Data z Meta Ads API (level=campaign). Divize se ƒçte z n√°zvu kampanƒõ podle vzoru
          <span class="badge">(D6)</span> ‚áí Divize 6. Bez z√°vorky ‚áí <span class="badge">Neza≈ôazeno</span>.
        </p>
      </div>

      <div class="controls">
        <div class="pill">
          Obdob√≠:
          <select id="period">
            <option value="7d">7 dn√≠</option>
            <option value="30d" selected>30 dn√≠</option>
            <option value="90d">90 dn√≠</option>
          </select>
        </div>

        <div class="pill">
          Hledat:
          <input id="q" placeholder="ƒç√°st n√°zvu kampanƒõ‚Ä¶" />
        </div>

        <button class="btn" id="refreshBtn">Obnovit</button>
      </div>
    </header>

    <div id="tabs" class="tabs"></div>

    <div id="error" class="err" style="display:none"></div>

    <div class="grid" id="kpis"></div>

    <div class="card table">
      <table>
        <thead>
          <tr>
            <th>Kampa≈à</th>
            <th>Divize</th>
            <th class="right">Spend</th>
            <th class="right">Impr.</th>
            <th class="right">Clicks</th>
            <th class="right">Reach</th>
            <th class="right">CTR</th>
            <th class="right">CPC</th>
            <th class="right">Results</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="status">
        <span id="healthDot" class="dot" title="API status"></span>
        <span id="statusText" class="muted">P≈ôipraveno</span>
        <span id="loading" style="display:none" class="spinner" title="Naƒç√≠t√°m‚Ä¶"></span>
      </div>
      <div class="muted">
        Endpoint: <code>/api/campaigns?division=‚Ä¶&period=‚Ä¶</code>
      </div>
    </div>
  </div>

<script>
  // ---- helpers ----
  const fmtCZK = (n) => new Intl.NumberFormat("cs-CZ", { style:"currency", currency:"CZK", maximumFractionDigits:0 }).format(n || 0);
  const fmtInt = (n) => new Intl.NumberFormat("cs-CZ").format(n || 0);
  const pct = (n) => `${(Math.round((n||0)*100)/100).toLocaleString("cs-CZ")} %`;
  const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  function getParam(name, fallback=""){
    const u = new URL(location.href);
    return u.searchParams.get(name) ?? fallback;
  }
  function setParam(name, value){
    const u = new URL(location.href);
    if (value === "" || value == null) u.searchParams.delete(name);
    else u.searchParams.set(name, value);
    history.replaceState(null, "", u.toString());
  }

  function getDivisions(rows){
    const set = new Set(rows.map(r => r.division));
    const nums = [...set].filter(d => /^D\d+$/i.test(d)).sort((a,b)=>parseInt(a.slice(1))-parseInt(b.slice(1)));
    const ordered = ["V≈°e", ...nums];
    if (set.has("Neza≈ôazeno")) ordered.push("Neza≈ôazeno");
    return ordered;
  }

  function showError(msg){
    const el = document.getElementById("error");
    if (!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block";
    el.textContent = msg;
  }

  function setHealth(ok){
    const dot = document.getElementById("healthDot");
    dot.classList.toggle("bad", !ok);
  }

  function setStatus(text, loading=false){
    document.getElementById("statusText").textContent = text;
    document.getElementById("loading").style.display = loading ? "inline-block" : "none";
  }

  // ---- state ----
  const state = {
    period: getParam("period", "30d"),
    division: getParam("division", "D6") || "D6",
    q: getParam("q", ""),
    raw: null,
    rows: []
  };

  document.getElementById("period").value = state.period;
  document.getElementById("q").value = state.q;

  document.getElementById("period").addEventListener("change", (e)=>{
    state.period = e.target.value;
    setParam("period", state.period);
    loadAndRender();
  });

  document.getElementById("q").addEventListener("input", (e)=>{
    state.q = e.target.value.trim();
    setParam("q", state.q);
    render(); // jen klientsk√Ω filtr bez fetch
  });

  document.getElementById("refreshBtn").addEventListener("click", ()=>{
    loadAndRender(true);
  });

  async function fetchCampaigns(division, period){
    const url = `/api/campaigns?division=${encodeURIComponent(division)}&period=${encodeURIComponent(period)}`;
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json().catch(()=>null);
    if (!res.ok) {
      const msg = data ? JSON.stringify(data, null, 2) : `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function renderTabs(allRows){
    const tabsEl = document.getElementById("tabs");
    tabsEl.innerHTML = "";

    const divisions = getDivisions(allRows);

    // fallback pokud nen√≠ v datech
    if (!divisions.includes(state.division)) {
      state.division = divisions.includes("D6") ? "D6" : "V≈°e";
      setParam("division", state.division);
    }
function tabLabel(div) {
  if (div === "V≈°e") return "V≈°e";
  if (div === "Neza≈ôazeno") return "Neza≈ôazeno";
  const m = String(div).match(/^D(\d+)$/i);
  return m ? `Divize ${m[1]}` : div;
}
divisions.forEach(div => {
  const b = document.createElement("button");
  b.className = "tab" + (div === state.division ? " active" : "");
  b.textContent = tabLabel(div);   // üëà tady je zmƒõna
  b.onclick = () => {
    state.division = div;          // hodnota pro API z≈Øst√°v√° D1, D3‚Ä¶
    render();
  };
  tabsEl.appendChild(b);
});
  }

  function renderKpisFrom(kpi){
    const items = [
      { label:"Spend", value: fmtCZK(kpi.spend), sub:`Za ${state.period.replace("d","")} dn√≠` },
      { label:"Impressions", value: fmtInt(kpi.impressions), sub:"Zobrazen√≠" },
      { label:"Clicks", value: fmtInt(kpi.clicks), sub:"Kliknut√≠" },
      { label:"Reach", value: fmtInt(kpi.reach), sub:"Dosah" },
      { label:"CTR", value: pct(kpi.ctr), sub:"Clicks / Impr." },
      { label:"CPC", value: fmtCZK(kpi.cpc), sub:"Spend / Clicks" },
      { label:"Results", value: fmtInt(kpi.results), sub:"Zjednodu≈°enƒõ z actions" },
    ];

    const el = document.getElementById("kpis");
    el.innerHTML = "";
    items.forEach(it=>{
      const c = document.createElement("div");
      c.className = "card kpi";
      c.innerHTML = `<div class="label">${it.label}</div><div class="value">${it.value}</div><div class="sub">${it.sub}</div>`;
      el.appendChild(c);
    });
  }

  function renderTable(rows){
    const q = state.q.toLowerCase();
    const filtered = q ? rows.filter(r => (r.campaign_name||"").toLowerCase().includes(q)) : rows;

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    filtered.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="name">${escapeHtml(r.campaign_name)}</div>
          <div class="muted small">ID: ${escapeHtml(r.campaign_id)}</div>
        </td>
        <td><span class="badge">${escapeHtml(r.division)}</span></td>
        <td class="right">${fmtCZK(r.spend)}</td>
        <td class="right">${fmtInt(r.impressions)}</td>
        <td class="right">${fmtInt(r.clicks)}</td>
        <td class="right">${fmtInt(r.reach)}</td>
        <td class="right">${pct(r.ctr)}</td>
        <td class="right">${fmtCZK(r.cpc)}</td>
        <td class="right">${fmtInt(r.results)}</td>
      `;
      tbody.appendChild(tr);
    });

    setStatus(`Zobrazeno ${filtered.length} kampan√≠ (${state.division}, ${state.period})`, false);
  }

  // render using current state.raw
  function render(){
    if (!state.raw) return;
    showError("");
    setHealth(true);

    // Tabs pot≈ôebuj√≠ seznam diviz√≠ ‚Äì z√≠sk√°me je z "V≈°e" datasetu
    // Pokud jsme zrovna nefetchnuli "V≈°e", dot√°hneme rychle v backgroundu
    renderTable(state.rows);
  }

  // load data
  async function loadAndRender(force=false){
    showError("");
    setStatus("Naƒç√≠t√°m data z Meta‚Ä¶", true);

    try {
      // 1) kv≈Øli tab≈Øm si v≈ædy jednou st√°hneme "V≈°e" (jen pro seznam diviz√≠)
      //    (cache v JS ‚Äì dal≈°√≠ kliky u≈æ netahaj√≠ zbyteƒçnƒõ)
      if (!state._allCache || force || state._allCachePeriod !== state.period) {
        const all = await fetchCampaigns("V≈°e", state.period);
        state._allCache = all;
        state._allCachePeriod = state.period;
        renderTabs(all.campaigns || []);
      } else {
        renderTabs(state._allCache.campaigns || []);
      }

      // 2) st√°hni data pro vybranou divizi (server-side filtr)
      const data = await fetchCampaigns(state.division, state.period);
      state.raw = data;
      state.rows = (data.campaigns || []).slice().sort((a,b)=> (b.spend||0)-(a.spend||0));

      renderKpisFrom(data.kpi || {spend:0,impressions:0,clicks:0,reach:0,ctr:0,cpc:0,results:0});
      renderTable(state.rows);

    } catch (e) {
      setHealth(false);
      setStatus("Chyba p≈ôi naƒç√≠t√°n√≠", false);
      showError(String(e && e.message ? e.message : e));
      // fallback UI
      document.getElementById("kpis").innerHTML = "";
      document.getElementById("tbody").innerHTML = "";
    } finally {
      document.getElementById("loading").style.display = "none";
    }
  }

  // init
  loadAndRender();
</script>
</body>
</html>
